#!/usr/bin/env bash
set -euo pipefail

# --- Directory Constants ---
INSTALL_DIR="$HOME/.local/share/tmoe"
CONTAINER_DIR="$INSTALL_DIR/containers"
CACHE_DIR="$INSTALL_DIR/cache"

# --- Repository Constants ---
DEBIAN_REPO="https://images.linuxcontainers.org/images/debian/trixie/arm64/default"
PROC_URL="https://github.com/cu233/proot_proc/raw/master/proc.tar.xz"

# --- Constants ---
ARCH_TYPE="arm64"

# --- Colors ---
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
RESET='\033[0m'
BOLD='\033[1m'

# --- Initialization ---
mkdir -p "$CONTAINER_DIR" "$CACHE_DIR"

# --- Helper Functions ---

log_info() { echo -e "${GREEN}[INFO]${RESET} $1" >&2; }
log_warn() { echo -e "${YELLOW}[WARN]${RESET} $1" >&2; }
log_error() { echo -e "${RED}[ERROR]${RESET} $1" >&2; }
log_title() { echo -e "${BOLD}${BLUE}== $1 ==${RESET}" >&2; }

check_dependencies() {
    for cmd in curl tar sha256sum proot; do
        if command -v "$cmd" >/dev/null; then continue; fi

        log_warn "Dependency '$cmd' missing. Installing..."
        local pkg_name="$cmd"
        [[ "$cmd" == "sha256sum" ]] && pkg_name="coreutils"

        if command -v pkg >/dev/null; then
            pkg install -y "$pkg_name"
        elif command -v apt >/dev/null; then
            apt install -y "$pkg_name"
        else
            log_error "Package manager not found. Please install '$pkg_name' manually."
            exit 1
        fi
    done
}

show_help() {
    log_title "TMOE CLI Interface"
    echo "Usage:"
    echo "  tmoe help"
    echo "  tmoe list"
    echo "  tmoe distro {distro_name} {container_name}"
    echo "  tmoe login {container_name}"
}

list_containers() {
    log_title "Installed Containers"
    if [[ -d "$CONTAINER_DIR" ]] && [[ "$(ls -A "$CONTAINER_DIR")" ]]; then
        ls -1 "$CONTAINER_DIR"
    else
        echo "No containers found."
    fi
}

download_rootfs() {
    local out_dir="$1"
    local repo="$2"
    local distro; distro=$(echo "$repo" | cut -d'/' -f5)
    local arch; arch=$(echo "$repo" | cut -d'/' -f7)

    local date_url; date_url=$(curl -sL "$repo" |
    grep -oE 'href="[0-9]{8}_[0-9]{2}(:|%3A)[0-9]{2}/"' |
    sed 's/href="//;s/"//;s/%3A/:/g' |
    sort | tail -n 1) || {
        log_error "Failed to get latest rootfs."
        return 1
    }
    log_info "Latest rootfs: ${date_url%/}"
    
    local full_url="${repo}/${date_url}"
    local rootfs_name="rootfs.tar.xz"
    local sha256_name="SHA256SUMS"
    local rootfs_file="$out_dir/${distro}-${arch}-${date_url%/}-$rootfs_name"
    local sha256_file="$out_dir/${distro}-${arch}-${date_url%/}-$sha256_name"

    # Download SHA256SUMS
    log_info "Checking checksums..."
    curl -sL -o "$sha256_file" "${full_url}${sha256_name}"

    local expected_sha256; expected_sha256=$(grep "$rootfs_name" "$sha256_file" | awk '{print $1}')

    verify_checksum() {
        local rootfs_file="$1"
        local expected_sha256="$2"
        local actual_sha256; actual_sha256=$(sha256sum "$rootfs_file" | awk '{print $1}')
        [[ "$actual_sha256" == "$expected_sha256" ]]
    }

    # Cleanup Old Cache
    for f in "${out_dir}/${distro}-${arch}-*-rootfs.tar.xz" "${out_dir}/${distro}-${arch}-*-SHA256SUMS"; do
        [[ -f "$f" ]] || continue
        if [[ "$f" != "$rootfs_file" && "$f" != "$sha256_file" ]]; then
            log_info "Removing old cache file: $(basename "$f")"
            rm -f "$f"
        fi
    done

    # Check Cache
    if [[ -f "$rootfs_file" ]] && [[ -n "$expected_sha256" ]] && verify_checksum "$rootfs_file" "$expected_sha256"; then
        log_info "Cache valid. Using cached file."
    else
        log_info "Downloading rootfs to cache..."
        curl -L -o "$rootfs_file" "${full_url}${rootfs_name}" --progress-bar || { log_error "Download failed."; return 1; }
        verify_checksum "$rootfs_file" "$expected_sha256" || { log_error "Checksum verification failed."; return 1; }
    fi

    echo "$rootfs_file"
}

extract_rootfs() {
    local rootfs_file="$1"
    local target_dir="$2"

    log_info "Extracting rootfs (using proot)..."
    mkdir -p "$target_dir"

    if command -v pv >/dev/null; then
        pv "$rootfs_file" | proot --link2symlink tar -pJx -C "$target_dir" 2>/dev/null
    else
        proot --link2symlink tar -pJxf "$rootfs_file" -C "$target_dir" 2>/dev/null
    fi

    if [[ ! -f "$target_dir/bin/bash" ]]; then
        log_error "Extraction failed or invalid rootfs."
        rm -rf "$target_dir"
        return 1
    fi
}

install_distro() {
    check_dependencies

    local distro="${1:-}"
    local container_name="${2:-}"

    if [[ -z "$distro" || -z "$container_name" ]]; then
        log_error "Missing arguments."
        echo "Usage: tmoe distro {distro_name} {container_name}"
        return 1
    fi

    if [[ "$distro" != "debian" ]]; then
        log_error "Currently only 'debian' is supported."
        return 1
    fi

    local target_dir="$CONTAINER_DIR/$container_name"
    if [[ -d "$target_dir" ]]; then
        log_error "Container '$container_name' already exists."
        return 1
    fi

    log_title "Installing $distro ($ARCH_TYPE) to $target_dir"

    # 1. Get Version & Download
    local rootfs_file; rootfs_file=$(download_rootfs "$CACHE_DIR" "$DEBIAN_REPO")

    # 2. Extract
    extract_rootfs "$rootfs_file" "$target_dir"

    # 3. Install Proot Proc
    install_proot_proc "$target_dir"

    # 4. Post-Install
    log_info "Running post-installation steps..."
    configure_post_install "$target_dir"

    log_info "Installation Complete!"
    echo "Run 'tmoe login $container_name' to start."
}

install_proot_proc() {
    local target_root="$1"
    local proc_tar="$CACHE_DIR/proot_proc.tar.xz"

    log_info "Checking proot_proc..."
    if [[ ! -f "$proc_tar" ]]; then
        log_info "Downloading proot_proc to cache..."

        if [[ ! -f "$proc_tar" ]]; then
            curl -L -o "$proc_tar" "$PROC_URL"
        fi
    fi

    if [[ -f "$proc_tar" ]]; then
        log_info "Extracting proot_proc..."
        tar -Jxf "$proc_tar" -C "$target_root" 2>/dev/null
        mv "${target_root}/usr/local/etc/tmoe-linux/" "${target_root}/usr/local/etc/tmoe/"
    else
        log_warn "Failed to obtain proot_proc. Some features may not work."
    fi
}

function create_tmoe_proot_stat_file() {
    cat >"${TMOE_PROC_PREFIX}.stat" <<-'ENDOFSTAT'
cpu  13543674 2263150 11590764 15571271 210309 1343827 851885 0 0 0
cpu0 3629787 489276 3129188 15571051 210302 802654 516635 0 0 0
cpu1 3221514 563397 2565534 19 0 168835 110203 0 0 0
cpu2 2884314 491225 2361364 18 1 161981 92821 0 0 0
cpu3 2664267 457057 2282166 21 0 166631 88732 0 0 0
cpu4 365877 83980 417984 25 6 15600 10165 0 0 0
cpu5 296831 71203 325638 39 0 9363 14383 0 0 0
cpu6 262541 59844 288038 49 0 10350 10848 0 0 0
cpu7 218543 47168 220852 49 0 8413 8098 0 0 0
intr 1168051864 0 0 0 276005458 0 24952856 5 4 5 0 0 958 302 0 0 0 543988 116 0 1 0 92 184 0 0 0 0 0 0 0 2 0 145446 16538 11 11 358496 0 1779 0 0 0 0 0 1761 106944 0 221398 21826498 15065436 42829013 0 361294 4515 66197491 0 0 82 0 0 0 95 11438 0 0 0 0 0 0 0 0 0 0 288050 6 5498890 688446 388694 0 0 0 0 0 1674782 2042455 0 0 0 0 0 90 120387 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 9 7 190 0 1434 3096 2536 13 13822 11167 0 0 485674 0 4 3244478 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 9327 0 0 0 0 0 0 0 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 18 0 0 0 0 30003 0 0 0 1471954 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 3975713 62570 292 1841582 5903677 88 1324421 35786 38 0 95 601 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 77575 30048 0 680 0 106 0 0 0 0 0 0 0 38 0 0 0 0 0 0 116 111 112 0 113 80 17256 201 0 0 0 0 0 0 0 0 1071 0 12984 5 151277 20 171 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 6969 0 45 0 0 4309 20 0 10 4 0 0 0 0 618 0 0 587152 46371 1206 0 493 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
ctxt 1941467212
btime 1597149124
processes 1324243
procs_running 9
procs_blocked 1
softirq 268005113 132391 49905524 287215 24847758 108137456 132391 1472849 45583820 0 37505709
ENDOFSTAT
}

function check_tmoe_proot_container_proc() {
    [[ -z "$(head -n 1 /proc/stat 2>/dev/null)" ]] && { create_tmoe_proot_stat_file; sed -i "/.proot_proc.stat/s/^[[:space:]]*#/   /" "${TMOE_STARTUP_SCRIPT}"; }

    if [[ -z "$(head -n 1 /proc/version 2>/dev/null)" ]]; then
        printf "%s\n" "Detecting permission denied for /proc/version, faking..."
        echo "$(uname -a) (gcc version 10.1.0 20200630 (prerelease) (GCC) )" >"${TMOE_PROC_PREFIX}.version"
        sed -i "/.proot_proc.version/s/^[[:space:]]*#/   /" "${TMOE_STARTUP_SCRIPT}"
    fi

    [[ -z "$(head -n 1 /proc/bus/pci/devices 2>/dev/null)" ]] && sed -i "/proot_proc\/bus/s/^[[:space:]]*#/   /" "${TMOE_STARTUP_SCRIPT}"

    for i in buddyinfo cgroups consoles crypto devices diskstats execdomains fb filesystems interrupts iomem ioports kallsyms keys key-users kpageflags loadavg locks misc modules pagetypeinfo partitions sched_debug softirqs timer_list uptime vmallocinfo vmstat zoneinfo; do
        if [[ -z "$(sed -n p /proc/${i} 2>/dev/null)" ]]; then
            printf "%s\n" "Detecting permission denied for /proc/${i}, fixing..."
            sed -i "/proot_proc\/${i}/s/^[[:space:]]*#/   /" "${TMOE_STARTUP_SCRIPT}"
        fi
    done
}

function create_proot_startup_script() {
    local ROOTFS_DIR="$1"

    # Vars for the generated script
    local TMOE_CONFIG_DIR="${ROOTFS_DIR}/usr/local/etc/tmoe"
    local TMOE_STARTUP_SCRIPT="${TMOE_CONFIG_DIR}/start.sh"
    local TMOE_PROC_PREFIX="${TMOE_CONFIG_DIR}/.proot_proc"

    mkdir -p "${TMOE_CONFIG_DIR}"

    # Generate the script content
    cat >"${TMOE_STARTUP_SCRIPT}" <<-ENDOFPROOT
#!/usr/bin/env bash
set -euo pipefail

# Global Array for Building Command
CMD_ARGS=()

determine_shell() {
    # Default fallback
    TMOE_SHELL="/bin/bash"

    # Try to get shell from /etc/passwd in container
    if [[ -r "${ROOTFS_DIR}/etc/passwd" ]]; then
        local user_shell; user_shell=$\(grep "^root:" "${ROOTFS_DIR}/etc/passwd" | cut -d: -f7)

        [[ -n "\${user_shell}" ]] && [[ -x "${ROOTFS_DIR}\${user_shell}" ]] && TMOE_SHELL="\${user_shell}"
    fi

    echo "\${TMOE_SHELL}"
}

configure_environment() {
    # 1. Base command execution environment
    CMD_ARGS+=("/usr/bin/env" "-i") # Clear env

    # 2. Hostname
    CMD_ARGS+=("HOSTNAME=localhost")

    # 3. Basic Env Vars
    CMD_ARGS+=("HOME=/root")
    CMD_ARGS+=("USER=root")
    CMD_ARGS+=("TERM=xterm-256color")
    CMD_ARGS+=("TMPDIR=/tmp")
    CMD_ARGS+=("DISPLAY=:0") # Default display
    CMD_ARGS+=("TZ=$(getprop persist.sys.timezone)")

    # 4. Locale
    CMD_ARGS+=("LANG=en_US.UTF-8")

    # 5. PATH
    CMD_ARGS+=("PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin")

    # 6. Shell
    CMD_ARGS+=("SHELL=\$(determine_shell)" "\$(determine_shell)" "-l")
}

main() {
    unset LD_PRELOAD

    CMD_ARGS+=("--root-id" "--pwd=/root" "--rootfs=${ROOTFS_DIR}")

    CMD_ARGS+=("--link2symlink" "--kill-on-exit" "--sysvipc" "-L")

    CMD_ARGS+=("--mount=/system" "--mount=/apex")

    CMD_ARGS+=("--mount=/proc")

    CMD_ARGS+=("--mount=/dev")

    CMD_ARGS+=("--mount=${ROOTFS_DIR}/tmp:/dev/shm")
    CMD_ARGS+=("--mount=/dev/urandom:/dev/random")
    CMD_ARGS+=("--mount=/proc/self/fd:/dev/fd")
    CMD_ARGS+=("--mount=/proc/self/fd/0:/dev/stdin")
    CMD_ARGS+=("--mount=/proc/self/fd/1:/dev/stdout")
    CMD_ARGS+=("--mount=/proc/self/fd/2:/dev/stderr")
    CMD_ARGS+=("--mount=/dev/null:/dev/tty0")

    CMD_ARGS+=("--mount=/dev/null:/proc/sys/kernel/cap_last_cap")

    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/.proot_proc.stat:/proc/stat")

    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/.proot_proc.version:/proc/version")

    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/bus:/proc/bus")

    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/buddyinfo:/proc/buddyinfo")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/cgroups:/proc/cgroups")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/consoles:/proc/consoles")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/crypto:/proc/crypto")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/devices:/proc/devices")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/diskstats:/proc/diskstats")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/execdomains:/proc/execdomains")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/fb:/proc/fb")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/filesystems:/proc/filesystems")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/interrupts:/proc/interrupts")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/iomem:/proc/iomem")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/ioports:/proc/ioports")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/kallsyms:/proc/kallsyms")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/keys:/proc/keys")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/key-users:/proc/key-users")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/kpageflags:/proc/kpageflags")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/loadavg:/proc/loadavg")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/locks:/proc/locks")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/misc:/proc/misc")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/modules:/proc/modules")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/pagetypeinfo:/proc/pagetypeinfo")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/partitions:/proc/partitions")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/sched_debug:/proc/sched_debug")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/softirqs:/proc/softirqs")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/timer_list:/proc/timer_list")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/uptime:/proc/uptime")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/vmallocinfo:/proc/vmallocinfo")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/vmstat:/proc/vmstat")
    # CMD_ARGS+=("--mount=${ROOTFS_DIR}/usr/local/etc/tmoe/proot_proc/zoneinfo:/proc/zoneinfo")

    CMD_ARGS+=("--mount=/storage/emulated/0:/sdcard")
    
    configure_environment

    proot "\${CMD_ARGS[@]}"
}

# Start
main "$@"
ENDOFPROOT

    # Run the checks on the generated script
    check_tmoe_proot_container_proc

    chmod +x "${TMOE_STARTUP_SCRIPT}"
}

configure_dns() {
    local rootfs="$1"
    log_info "Configuring DNS..."
    rm -f "$rootfs/etc/resolv.conf"
    cat >"$rootfs/etc/resolv.conf" <<-'EOF'
nameserver 1.1.1.1
nameserver 1.0.0.1
nameserver 2606:4700:4700::1111
nameserver 2606:4700:4700::1001
EOF
}

configure_sources() {
    local rootfs="$1"
    log_info "Configuring APT sources..."
    if [[ -f "$rootfs/etc/apt/sources.list" ]]; then
        mv "$rootfs/etc/apt/sources.list" "$rootfs/etc/apt/sources.list.bak"
    fi
    dirname "$rootfs/etc/apt" | xargs mkdir -p
    cat >"$rootfs/etc/apt/sources.list" <<-'EOF'
deb http://deb.debian.org/debian/ trixie main contrib non-free non-free-firmware
deb http://deb.debian.org/debian/ trixie-updates main contrib non-free non-free-firmware
deb http://deb.debian.org/debian-security/ trixie-security main contrib non-free non-free-firmware
EOF
}

configure_hostname() {
    local rootfs="$1"
    log_info "Configuring hostname..."
    echo "localhost" >"$rootfs/etc/hostname"
}

configure_zsh() {
    local rootfs="$1"
    log_info "Configuring ZSH setup..."

    local font_url="https://github.com/ryanoasis/nerd-fonts/raw/master/patched-fonts/JetBrainsMono/Ligatures/Regular/JetBrainsMonoNerdFontMono-Regular.ttf"
    local cached_font="$CACHE_DIR/${font_url##*/}"

    # Download if not in cache
    if [[ ! -f "$cached_font" ]]; then
        log_info "Downloading ${font_url##*/} to cache..."
        curl -fLo "$cached_font" "$font_url" || {
            log_error "Failed to download font."
            rm -f "$cached_font"
            return 1
        }
    fi

    # Symlink to Termux
    if [[ -f "$cached_font" ]]; then
        mkdir -p "$HOME/.termux"
        log_info "Applying font..."
        ln -sf "$cached_font" "$HOME/.termux/font.ttf"
        command -v termux-reload-settings >/dev/null && termux-reload-settings
    fi

    # Backup original .profile
    if [[ -f "$rootfs/root/.profile" ]]; then
        mv "$rootfs/root/.profile" "$rootfs/root/.profile.bak"
    fi

    # Create setup .profile
    cat >"$rootfs/root/.profile" <<-'EOF'
#!/usr/bin/env bash
set -euo pipefail

BLUE='\033[34m'
RESET='\033[0m'
BOLD='\033[1m'

log_title() { echo -e "${BOLD}${BLUE}== $1 ==${RESET}" >&2; }

log_title "First launch detected. Running initial setup..."

# Update and Install
apt-get update
apt-get install -y curl file git zsh

# Change default shell
if command -v zsh >/dev/null; then
    echo "Changing default shell to zsh..."
    chsh -s /bin/zsh
else
    echo "Error: zsh install failed."
fi

if [[ ! -f $HOME/.local/share/zinit/zinit.git/zinit.zsh ]]; then
    printf "\033[33mInstalling ZDHARMA-CONTINUUM Initiative Plugin Manager (zdharma-continuum/zinit)â€¦\033[0m\n"
    mkdir -p "$HOME/.local/share/zinit" && chmod g-rwX "$HOME/.local/share/zinit"
    git clone --depth 1 https://github.com/zdharma-continuum/zinit "$HOME/.local/share/zinit/zinit.git" && \
        printf "\033[32mInstallation successful.\033[0m\n" || \
        printf "\033[31mThe clone has failed.\033[0m\n"
fi

# Restore original profile
echo "Restoring original environment..."
rm -f "$HOME/.profile"
if [ -f "$HOME/.profile.bak" ]; then
    mv "$HOME/.profile.bak" "$HOME/.profile"
fi

echo "Setup complete!"
echo "Please re-login to enter your new ZSH environment."
echo "Exiting..."
sleep 2
exit 0
EOF

    # Create .zshrc
    cat >"$rootfs/root/.zshrc" <<-'EOF'
HISTFILE="$HOME/.zsh_history"
SAVEHIST=10000
setopt SHARE_HISTORY
setopt HIST_IGNORE_DUPS

setopt AUTO_CD
setopt AUTO_PUSHD

source "$HOME/.local/share/zinit/zinit.git/zinit.zsh"
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

zinit ice as"command" from"gh-r" \
    bpick"*$(uname -m)*linux-musl*" \
    mv"starship* -> starship" \
    atclone'
        mkdir -p ~/.config; 
        ./starship preset gruvbox-rainbow >! ~/.config/starship.toml; 
        ./starship init zsh > init.zsh; 
        ./starship completions zsh > _starship' \
    atpull'%atclone' \
    src"init.zsh"
zinit light starship/starship

zinit ice depth"1" wait lucid
zinit light zdharma-continuum/fast-syntax-highlighting
EOF
}

configure_post_install() {
    local rootfs="$1"

    configure_dns "$rootfs"
    configure_sources "$rootfs"
    configure_hostname "$rootfs"
    configure_zsh "$rootfs"

    # Generate Startup Script
    create_proot_startup_script "$rootfs"
}

login_container() {
    check_dependencies
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        log_error "Missing container name."
        echo "Usage: tmoe login {container_name}"
        return 1
    fi

    local start_script="$CONTAINER_DIR/$name/usr/local/etc/tmoe/start.sh"

    if [[ -x "$start_script" ]]; then
        log_title "Logging into $name..."
        "$start_script"
    else
        log_error "Container '$name' not found or start script missing."
        log_warn "Path checked: $start_script"
        return 1
    fi
}

# --- Main Dispatch ---

main() {
    case "${1:-}" in
    help | --help | -h)
        show_help
        ;;
    list)
        list_containers
        ;;
    distro)
        shift
        install_distro "$@"
        ;;
    login)
        shift
        login_container "$@"
        ;;
    *)
        show_help
        ;;
    esac
}

main "$@"
